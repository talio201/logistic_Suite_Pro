<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="shortcut icon" href="./icons/logistic_favicon_title.png" type="image/x-icon" />
    <title>LogisSuite - Pro - Painel Gerencial</title>
    <style> ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: #f1f1f1; } ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; } ::-webkit-scrollbar-thumb:hover { background: #555; } </style>
</head>
<body class="bg-gray-100 font-sans">
    <div class="flex h-screen bg-gray-200">
        <aside class="w-64 bg-gray-800 text-white flex-col hidden sm:flex">
             <div class="px-6 py-4 border-b border-gray-700 flex items-center"><img src="./icons/logistic_favicon_title.png" alt="Logo" class="h-8 w-8 mr-2"><h1 class="text-2xl font-bold text-green-400">LogisSuite Pro</h1></div>
            <nav class="flex-grow px-4 py-4">
                <a href="#" class="flex items-center px-4 py-2 mt-2 text-gray-100 bg-gray-700 rounded"><svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>Visão Geral</a>
            </nav>
            <div class="px-6 py-4 border-t border-gray-700"><a href="#" id="logout-button" class="flex items-center px-4 py-2 text-gray-100 rounded hover:bg-red-700"><svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>Sair</a></div>
        </aside>

        <div class="flex-1 flex flex-col overflow-hidden">
            <header class="bg-white shadow-md p-4 flex justify-between items-center"><h2 class="text-2xl font-semibold text-gray-800">Painel Gerencial</h2><div class="flex items-center"><span class="text-gray-600 mr-4" id="welcome-message">Carregando...</span><img class="w-10 h-10 rounded-full" src="https://i.pravatar.cc/150" alt="Avatar"></div></header>
            <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-6" id="main-content">
                <div class="text-center p-10">Carregando dados do dashboard...</div>
            </main>
        </div>
    </div>

<script>
    const token = localStorage.getItem('token');
    let statusChart = null; // Variáveis globais para os gráficos para que possam ser destruídos
    let revenueChart = null;

    // Busca os dados do usuário (nome)
    async function fetchUserProfile() { /* ... (código inalterado) ... */ }

    // Busca todos os dados do dashboard de uma só vez
    async function fetchDashboardData() {
        if (!token) { window.location.href = '/index.html'; return; }
        
        try {
            const response = await fetch('/api/dashboard/overview', { headers: { 'x-access-token': token } });
            if (!response.ok) throw new Error('Falha ao buscar dados do dashboard');
            
            const data = await response.json();
            renderDashboard(data);
        } catch (error) {
            document.getElementById('main-content').innerHTML = '<p class="text-red-500 text-center">Erro ao carregar os dados do painel.</p>';
            console.error("Erro ao carregar dados do dashboard:", error);
        }
    }

    // Renderiza o dashboard com os dados recebidos
    function renderDashboard(data) {
        const mainContent = document.getElementById('main-content');
        mainContent.innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <div class="bg-white p-5 rounded-lg shadow"><p class="text-sm font-medium text-gray-500">Total de Pedidos</p><p class="text-3xl font-bold">${data.kpis.totalPedidos}</p></div>
                <div class="bg-white p-5 rounded-lg shadow"><p class="text-sm font-medium text-gray-500">Total de Produtos</p><p class="text-3xl font-bold">${data.kpis.totalProdutos}</p></div>
                <div class="bg-white p-5 rounded-lg shadow"><p class="text-sm font-medium text-gray-500">Total de Filiais</p><p class="text-3xl font-bold">${data.kpis.totalFiliais}</p></div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md">
                    <h3 class="font-semibold text-lg mb-4">Faturamento por Dia (Últimos 30 dias)</h3>
                    <canvas id="revenueChart"></canvas>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="font-semibold text-lg mb-4">Pedidos por Status</h3>
                    <canvas id="statusChart"></canvas>
                </div>
            </div>
             <div class="mt-6 bg-white p-6 rounded-lg shadow-md">
                <h3 class="font-semibold text-lg mb-4">Pedidos Recentes</h3>
                <table class="w-full text-left">
                    <thead><tr class="border-b"><th class="py-2">Pedido ID</th><th>Filial</th><th>Status</th></tr></thead>
                    <tbody id="recent-orders-table"></tbody>
                </table>
            </div>
        `;

        // Renderiza os gráficos e a tabela
        createStatusChart(data.charts.ordersByStatus);
        createRevenueChart(data.charts.revenueByDay);
        populateRecentOrders(data.tables.recentOrders);
    }

    function createStatusChart(data) {
        const ctx = document.getElementById('statusChart')?.getContext('2d');
        if (statusChart) statusChart.destroy(); // Destrói gráfico antigo se existir
        if (ctx) {
            statusChart = new Chart(ctx, {
                type: 'doughnut', data: { labels: data.labels, datasets: [{ data: data.values, backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0'] }] },
                options: { responsive: true, plugins: { legend: { position: 'top' } } }
            });
        }
    }
    
    function createRevenueChart(data) {
        const ctx = document.getElementById('revenueChart')?.getContext('2d');
        if (revenueChart) revenueChart.destroy();
        if (ctx) {
            revenueChart = new Chart(ctx, {
                type: 'line', data: { labels: data.labels, datasets: [{ label: 'Faturamento R$', data: data.values, borderColor: '#36A2EB', tension: 0.1, fill: false }] },
                options: { responsive: true, scales: { y: { beginAtZero: true } } }
            });
        }
    }

    function populateRecentOrders(orders) {
        const tableBody = document.getElementById('recent-orders-table');
        tableBody.innerHTML = orders.map(order => `
            <tr class="border-b hover:bg-gray-50">
                <td class="py-2">${order.order_id}</td>
                <td class="py-2">${order.branch_name}</td>
                <td class="py-2"><span class="px-2 py-1 text-xs font-semibold text-white bg-blue-500 rounded-full">${order.order_status}</span></td>
            </tr>
        `).join('');
    }

    // Ponto de entrada
    (async function init() {
        await fetchUserProfile();
        await fetchDashboardData();
    })();

    // Lógica de Logout
    document.getElementById('logout-button').addEventListener('click', (e) => { e.preventDefault(); localStorage.removeItem('token'); window.location.href = '/index.html'; });
</script>
</body>
</html>